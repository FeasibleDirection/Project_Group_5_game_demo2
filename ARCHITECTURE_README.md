# å¤šäººé£æœºå¯¹æˆ˜æ¸¸æˆ - åŒæ¶æ„å®ç°

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

æœ¬é¡¹ç›®å®ç°äº†ä¸¤ç§ä¸åŒçš„å¤šäººæ¸¸æˆæ¶æ„ï¼Œç”¨äºå¯¹æ¯”å’Œè¯„ä¼°ï¼š

### **Architecture A: Server-Authoritative + Event-Driven**  (å·²å®ç°)
### **Architecture B: P2P Lockstep** â³ (å¾…å®ç°)

---

## ğŸ“Š Architecture A - æœåŠ¡å™¨æƒå¨ + äº‹ä»¶é©±åŠ¨

### **æ ¸å¿ƒç†å¿µ**

- **æœåŠ¡å™¨æƒå¨**: æ‰€æœ‰æ¸¸æˆé€»è¾‘åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ
- **å®¢æˆ·ç«¯ä»…å‘é€è¾“å…¥**: å®¢æˆ·ç«¯åªå‘é€WASD+JæŒ‰é”®çŠ¶æ€
- **çŠ¶æ€å¹¿æ’­**: æœåŠ¡å™¨æ¯40msï¼ˆ25Hzï¼‰å¹¿æ’­æ¸¸æˆçŠ¶æ€
- **äº‹ä»¶é©±åŠ¨**: æ¨¡å—é—´é€šè¿‡EventBusè§£è€¦é€šä¿¡

### **æ•°æ®æµ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Input(WASD+J)   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚  WebSocket  â”‚
â”‚         â”‚                  â”‚   Handler   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â–²                              â”‚
     â”‚                              â–¼
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    â”‚   Event Bus     â”‚
     â”‚                    â”‚  (InputEvent)   â”‚
     â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                             â”‚
     â”‚                             â–¼
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    â”‚  Physics Engine â”‚
     â”‚                    â”‚  - Apply Input  â”‚
     â”‚                    â”‚  - Update Pos   â”‚
     â”‚  State Snapshot    â”‚  - Collision    â”‚
     â”‚  (25Hz)            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                             â”‚
     â”‚                             â–¼
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    â”‚   Game Tick     â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   Scheduler     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   (25Hz Loop)   â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ç›®å½•ç»“æ„**

```
src/main/java/com/projectgroup5/gamedemo/
â”œâ”€â”€ event/                      # äº‹ä»¶é©±åŠ¨æ ¸å¿ƒ
â”‚   â”œâ”€â”€ EventBus.java          # äº‹ä»¶æ€»çº¿
â”‚   â”œâ”€â”€ GameEvent.java         # äº‹ä»¶æ¥å£
â”‚   â”œâ”€â”€ PlayerJoinedEvent.java
â”‚   â”œâ”€â”€ InputReceivedEvent.java
â”‚   â”œâ”€â”€ CollisionDetectedEvent.java
â”‚   â”œâ”€â”€ ScoreUpdatedEvent.java
â”‚   â””â”€â”€ GameEndedEvent.java
â”‚
â”œâ”€â”€ game/                       # æ¸¸æˆé€»è¾‘å±‚
â”‚   â”œâ”€â”€ GameWorld.java         # æ¸¸æˆä¸–ç•ŒçŠ¶æ€
â”‚   â”œâ”€â”€ PlayerEntity.java      # ç©å®¶å®ä½“
â”‚   â”œâ”€â”€ BulletEntity.java      # å­å¼¹å®ä½“
â”‚   â”œâ”€â”€ PlayerInput.java       # è¾“å…¥æ•°æ®
â”‚   â”œâ”€â”€ PhysicsEngine.java     # ç‰©ç†å¼•æ“
â”‚   â”œâ”€â”€ GameRoomManager.java   # æˆ¿é—´ç®¡ç†
â”‚   â””â”€â”€ GameTickScheduler.java # æ¸¸æˆå¾ªç¯ï¼ˆ25Hzï¼‰
â”‚
â”œâ”€â”€ websocket/                  # ç½‘ç»œé€šä¿¡å±‚
â”‚   â””â”€â”€ GameWebSocketHandler.java
â”‚
â””â”€â”€ config/
    â”œâ”€â”€ WebSocketConfig.java
    â””â”€â”€ SchedulingConfig.java
```

### **å…³é”®ç±»è¯´æ˜**

#### **1. EventBus (äº‹ä»¶æ€»çº¿)**
- å®ç°å‘å¸ƒ-è®¢é˜…æ¨¡å¼
- è§£è€¦å„æ¨¡å—é€šä¿¡
- æ”¯æŒç±»å‹å®‰å…¨çš„äº‹ä»¶å¤„ç†

```java
// è®¢é˜…äº‹ä»¶
eventBus.subscribe(CollisionDetectedEvent.class, event -> {
    // å¤„ç†ç¢°æ’...
});

// å‘å¸ƒäº‹ä»¶
eventBus.publish(new CollisionDetectedEvent(...));
```

#### **2. GameTickScheduler (æ¸¸æˆå¾ªç¯)**
- å›ºå®š25Hzï¼ˆ40ms/å¸§ï¼‰
- æ¯å¸§æ‰§è¡Œï¼šåº”ç”¨è¾“å…¥ â†’ æ›´æ–°ç‰©ç† â†’ ç¢°æ’æ£€æµ‹ â†’ å¹¿æ’­çŠ¶æ€
- æœåŠ¡å™¨æƒå¨ç¡®ä¿å…¬å¹³æ€§

#### **3. PhysicsEngine (ç‰©ç†å¼•æ“)**
- æœåŠ¡å™¨ç«¯è®¡ç®—æ‰€æœ‰ç§»åŠ¨å’Œç¢°æ’
- åä½œå¼Šï¼šéªŒè¯å°„é€Ÿã€ç§»åŠ¨é€Ÿåº¦
- åœ†å½¢ç¢°æ’æ£€æµ‹ï¼ˆAABBå¯æ‰©å±•ï¼‰

#### **4. GameWebSocketHandler (WebSocketå¤„ç†)**
- æ¥æ”¶å®¢æˆ·ç«¯è¾“å…¥
- å¹¿æ’­æ¸¸æˆçŠ¶æ€åˆ°æˆ¿é—´å†…æ‰€æœ‰ç©å®¶
- ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ

### **å®¢æˆ·ç«¯å®ç° (Architecture A)**

æ–‡ä»¶: `src/main/resources/static/js/game-architecture-a.js`

**æ ¸å¿ƒç‰¹ç‚¹**:
-  **åªå‘é€è¾“å…¥**: ä¸è®¡ç®—ä½ç½®ã€ç¢°æ’
-  **æ¥æ”¶çŠ¶æ€**: ä»æœåŠ¡å™¨æ¥æ”¶å®Œæ•´çŠ¶æ€
-  **60FPSæ¸²æŸ“**: æ’å€¼æ˜¾ç¤ºæµç•…ç”»é¢
-  **20Hzè¾“å…¥**: æ¯50mså‘é€ä¸€æ¬¡è¾“å…¥

```javascript
// å®¢æˆ·ç«¯åªåšè¿™äº›ï¼š
1. ç›‘å¬é”®ç›˜è¾“å…¥ (WASD+J)
2. é€šè¿‡WebSocketå‘é€è¾“å…¥åˆ°æœåŠ¡å™¨
3. æ¥æ”¶æœåŠ¡å™¨çŠ¶æ€å¿«ç…§
4. æ¸²æŸ“çŠ¶æ€ï¼ˆä¸åšç‰©ç†è®¡ç®—ï¼‰
```

### **ä¼˜åŠ¿**

| ä¼˜åŠ¿ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| å…¬å¹³æ€§ | â˜…â˜…â˜…â˜…â˜… | æœåŠ¡å™¨éªŒè¯æ‰€æœ‰æ“ä½œï¼Œé˜²ä½œå¼Š |
| ä¸€è‡´æ€§ | â˜…â˜…â˜…â˜…â˜… | å•ä¸€çœŸç›¸æºï¼Œæ— çŠ¶æ€åˆ†æ­§ |
| å¯æ‰©å±•æ€§ | â˜…â˜…â˜…â˜…â˜† | æ°´å¹³æ‰©å±•ï¼Œæ¯ä¸ªæˆ¿é—´ç‹¬ç«‹ |
| æ˜“ç»´æŠ¤ | â˜…â˜…â˜…â˜…â˜† | äº‹ä»¶é©±åŠ¨ï¼Œæ¨¡å—è§£è€¦ |
| å»¶è¿Ÿå®¹å¿ | â˜…â˜…â˜…â˜†â˜† | éœ€è¦å®¢æˆ·ç«¯é¢„æµ‹/æ’å€¼ä¼˜åŒ– |

### **åŠ£åŠ¿**

| åŠ£åŠ¿ | å½±å“ | ç¼“è§£æ–¹æ¡ˆ |
|------|------|----------|
| æœåŠ¡å™¨è´Ÿè½½é«˜ | ä¸­ | æˆ¿é—´åˆ†ç‰‡ã€é™åˆ¶æˆ¿é—´æ•° |
| ç½‘ç»œå»¶è¿Ÿå½±å“ä½“éªŒ | ä¸­ | å®¢æˆ·ç«¯é¢„æµ‹ã€æ’å€¼å¹³æ»‘ |
| éœ€è¦æœåŠ¡å™¨èµ„æº | é«˜ | P2Pæ¶æ„å¯ä½œä¸ºè¡¥å…… |

---

## ğŸ“Š Architecture B - P2P Lockstep (æœªå®ç°)

### **æ ¸å¿ƒç†å¿µ**

- **å»ä¸­å¿ƒåŒ–**: æ— éœ€ä¸“ç”¨æ¸¸æˆæœåŠ¡å™¨
- **ç¡®å®šæ€§åŒæ­¥**: æ‰€æœ‰å®¢æˆ·ç«¯è¿è¡Œç›¸åŒçš„è¾“å…¥åºåˆ—
- **é”æ­¥åè®®**: ç­‰å¾…æ‰€æœ‰ç©å®¶è¾“å…¥åç»Ÿä¸€æ¨è¿›
- **ä¸»æœºè¿ç§»**: ä¸´æ—¶ä¸»æœºæ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢

### **è®¡åˆ’å®ç°**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Input      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client Aâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Client Bâ”‚
â”‚         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     Input      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                          â”‚
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Client Câ”‚<â”€â”€â”€â”€â”€â”˜
               â”‚  (Host) â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               
æ¯å¸§åŒæ­¥ï¼š
1. æ”¶é›†æ‰€æœ‰ç©å®¶è¾“å…¥
2. å¹¿æ’­ç»™æ‰€æœ‰peer
3. æ‰€æœ‰å®¢æˆ·ç«¯æ‰§è¡Œç›¸åŒè¾“å…¥
4. éªŒè¯çŠ¶æ€å“ˆå¸Œä¸€è‡´æ€§
```

### **å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | Architecture A | Architecture B |
|------|----------------|----------------|
| æœåŠ¡å™¨éœ€æ±‚ | é«˜ï¼ˆæ¸¸æˆé€»è¾‘ï¼‰ | ä½ï¼ˆä»…ä¿¡ä»¤ï¼‰ |
| å»¶è¿Ÿ | 50-150ms | 20-50msï¼ˆå±€åŸŸç½‘ï¼‰ |
| å…¬å¹³æ€§ | æé«˜ | ä¸­ï¼ˆä¾èµ–å®¢æˆ·ç«¯ï¼‰ |
| é˜²ä½œå¼Š | å¼º | å¼± |
| æ‰©å±•æ€§ | å¥½ | å·®ï¼ˆpeeræ•°é‡å—é™ï¼‰ |
| ç½‘ç»œå®¹é”™ | å¥½ | å·®ï¼ˆéœ€è¦å…¨å‘˜åœ¨çº¿ï¼‰ |

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### **1. å¯åŠ¨æœåŠ¡å™¨**

```bash
mvn spring-boot:run
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:8080` å¯åŠ¨ã€‚

### **2. è®¿é—®å¤§å…**

æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://localhost:8080/lobby.html`

### **3. åˆ›å»ºæˆ¿é—´å¹¶é€‰æ‹©æ¶æ„**

1. ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"
2. è®¾ç½®ç©å®¶æ•°é‡ã€åœ°å›¾ã€èƒœåˆ©æ¡ä»¶
3. ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥
4. ä½œä¸ºæˆ¿ä¸»ï¼Œä½ ä¼šçœ‹åˆ°ä¸¤ä¸ªå¼€å§‹æŒ‰é’®ï¼š
   - **Start (Arch A)**: æœåŠ¡å™¨æƒå¨æ¨¡å¼ 
   - **Start (Arch B)**: P2Pæ¨¡å¼ â³ï¼ˆæœªå®ç°ï¼‰

### **4. æ¸¸æˆæ§åˆ¶**

- **WASD**: ç§»åŠ¨
- **J / Space**: å°„å‡»
- **ç›®æ ‡**: è¾¾åˆ°åˆ†æ•°æˆ–å­˜æ´»æœ€ä¹…

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### **Architecture A**

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… |
|------|------|------|
| æ¸¸æˆTické¢‘ç‡ | 25Hz |  25Hz |
| æ¸²æŸ“å¸§ç‡ | 60FPS |  60FPS |
| è¾“å…¥å»¶è¿Ÿ | <150ms |  50-100ms |
| åŒæ—¶åœ¨çº¿æˆ¿é—´ | 100 |  æ”¯æŒ |
| å•æˆ¿é—´ç©å®¶ | 1-4 |  æ”¯æŒ |

---

## ğŸ”§ æŠ€æœ¯æ ˆ

- **åç«¯**: Spring Boot 3.3.5, Java 17
- **WebSocket**: Spring WebSocket (SockJS fallbackå¯é€‰)
- **è°ƒåº¦**: Spring `@Scheduled` (25Hz fixed-rate)
- **å‰ç«¯**: åŸç”ŸJavaScript + Canvas API
- **æ•°æ®åº“**: SQLite (ç”¨æˆ·ã€æ¸¸æˆæ—¥å¿—)

---

## ğŸ“ APIç«¯ç‚¹

### **å¤§å…ç›¸å…³**

```
POST /api/lobby/rooms/{roomId}/start-architecture-a  # å¼€å§‹æ¸¸æˆ(Aæ¶æ„)
POST /api/lobby/rooms/{roomId}/start-architecture-b  # å¼€å§‹æ¸¸æˆ(Bæ¶æ„)
```

### **WebSocket**

```
WS /ws/game  # æ¸¸æˆWebSocketè¿æ¥

æ¶ˆæ¯æ ¼å¼ï¼š
{
  "type": "JOIN_GAME" | "PLAYER_INPUT" | "LEAVE_GAME",
  ...
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Fast-Paced Multiplayer (Gabriel Gambetta)](https://www.gabrielgambetta.com/client-server-game-architecture.html)
- [Valve's Source Multiplayer Networking](https://developer.valvesoftware.com/wiki/Source_Multiplayer_Networking)
- [Lockstep Protocol](https://en.wikipedia.org/wiki/Lockstep_protocol)

---

## ğŸ¯ æœªæ¥æ”¹è¿›

### **Architecture A ä¼˜åŒ–**
- [ ] å®¢æˆ·ç«¯é¢„æµ‹ï¼ˆClient-side Predictionï¼‰
- [ ] æœåŠ¡å™¨å’Œè§£ï¼ˆServer Reconciliationï¼‰
- [ ] å®ä½“æ’å€¼ï¼ˆEntity Interpolationï¼‰
- [ ] äºŒè¿›åˆ¶åè®®ï¼ˆProtobuf/CBORï¼‰
- [ ] Deltaå‹ç¼©ï¼ˆåªå‘é€å˜åŒ–ï¼‰

### **Architecture B å®ç°**
- [ ] WebRTC DataChannel
- [ ] ç¡®å®šæ€§ç‰©ç†å¼•æ“
- [ ] çŠ¶æ€å“ˆå¸ŒéªŒè¯
- [ ] ä¸»æœºè¿ç§»
- [ ] Rollback/Rewindæœºåˆ¶

---

## ğŸ‘¥ å›¢é˜Ÿ

- **Student 1**: Zhaoyuan Tian - æ¶æ„è®¾è®¡
- **Student 2**: Shikuan Xu - åç«¯å¼€å‘
- **Student 3**: Jing Xie - å‰ç«¯å¼€å‘

---

**ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-11-19  
**æ¶æ„çŠ¶æ€**: Architecture A  | Architecture B â³

